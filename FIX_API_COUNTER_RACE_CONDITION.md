# üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: Race Condition –≤ —Å—á–µ—Ç—á–∏–∫–µ API –∑–∞–ø—Ä–æ—Å–æ–≤

## –ü—Ä–æ–±–ª–µ–º–∞

**–°—á–µ—Ç—á–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–ª 38 –≤–º–µ—Å—Ç–æ 72 –∑–∞–ø—Ä–æ—Å–æ–≤**

### –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ?

–í –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–π —Å—Ä–µ–¥–µ (72 –≤–æ—Ä–∫–µ—Ä–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ) –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–∞ **race condition**:

```
–ë—ã–ª–æ (–Ω–µ–∞—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è):

1. Worker 1: —á–∏—Ç–∞–µ—Ç count = 0
2. Worker 2: —á–∏—Ç–∞–µ—Ç count = 0   ‚Üê –ï—â–µ –Ω–µ —É—Å–ø–µ–ª —É–≤–∏–¥–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è Worker 1!
3. Worker 1: –ø–∏—à–µ—Ç count = 1
4. Worker 2: –ø–∏—à–µ—Ç count = 1    ‚Üê –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç Worker 1!

–†–µ–∑—É–ª—å—Ç–∞—Ç: 2 –∑–∞–ø—Ä–æ—Å–∞, –Ω–æ —Å—á–µ—Ç—á–∏–∫ = 1 (–ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö!)
```

–ü—Ä–∏ 72 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö workers:
- –û–∂–∏–¥–∞–ª–æ—Å—å: 72 –∑–∞–ø—Ä–æ—Å–∞
- –ü–æ–ª—É—á–∞–ª–æ—Å—å: ~38-50 –∑–∞–ø—Ä–æ—Å–æ–≤ (–ø–æ—Ç–µ—Ä—è ~30-40% –¥–∞–Ω–Ω—ã—Ö)

## –†–µ—à–µ–Ω–∏–µ

**–ê—Ç–æ–º–∞—Ä–Ω–∞—è SQL –æ–ø–µ—Ä–∞—Ü–∏—è –≤–º–µ—Å—Ç–æ read-modify-write**

### –î–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):

```python
def increment_api_requests():
    current_count = get_api_requests_count()  # ‚Üê READ
    new_count = current_count + 1              # ‚Üê MODIFY
    set_parameter('vinted_api_requests', str(new_count))  # ‚Üê WRITE
    # ‚ùå –ù–ï –ê–¢–û–ú–ê–†–ù–û! –ú–µ–∂–¥—É READ –∏ WRITE –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ!
```

### –ü–û–°–õ–ï (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):

```python
def increment_api_requests():
    conn, db_type = get_db_connection()
    
    # PostgreSQL:
    cursor.execute("""
        UPDATE parameters 
        SET value = (CAST(value AS INTEGER) + 1)::TEXT 
        WHERE key = 'vinted_api_requests'
    """)
    
    # ‚úÖ –ê–¢–û–ú–ê–†–ù–û! SQL —Å–∞–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø!
```

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å?

SQL –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö **–°–ê–ú–ê** –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å:

```
Worker 1: UPDATE parameters SET value = value + 1  ‚Üê –ë–µ—Ä–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É —Å—Ç—Ä–æ–∫–∏
Worker 2: UPDATE parameters SET value = value + 1  ‚Üê –ñ–¥–µ—Ç –ø–æ–∫–∞ Worker 1 –æ—Å–≤–æ–±–æ–¥–∏—Ç
Worker 3: UPDATE parameters SET value = value + 1  ‚Üê –ñ–¥–µ—Ç –≤ –æ—á–µ—Ä–µ–¥–∏
...

–†–µ–∑—É–ª—å—Ç–∞—Ç: –í–°–ï –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ!
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **–°—á–µ—Ç—á–∏–∫ —Ç–µ–ø–µ—Ä—å —Ç–æ—á–Ω–æ —Å—á–∏—Ç–∞–µ—Ç –≤—Å–µ API –∑–∞–ø—Ä–æ—Å—ã**

```
72 workers √ó 1 –∑–∞–ø—Ä–æ—Å = 72 –∑–∞–ø—Ä–æ—Å–∞ –≤ —Å—á–µ—Ç—á–∏–∫–µ
```

–ë–µ–∑ –ø–æ—Ç–µ—Ä—å –¥–∞–Ω–Ω—ã—Ö! üéâ

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å?

**–§–∞–π–ª:** `db.py`  
**–§—É–Ω–∫—Ü–∏—è:** `increment_api_requests()`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:**
- –£–±—Ä–∞–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—è read-modify-write
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∞—Ç–æ–º–∞—Ä–Ω–∞—è SQL –æ–ø–µ—Ä–∞—Ü–∏—è UPDATE
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ PostgreSQL –∏ SQLite

## –ö–æ–≥–¥–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è?

–ü–æ—Å–ª–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–µ–ø–ª–æ—è –Ω–∞ Railway —Å—á–µ—Ç—á–∏–∫ –±—É–¥–µ—Ç —Å—á–∏—Ç–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ!

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

**Race condition** - –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–º –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–∏:
- –í–æ–∑–Ω–∏–∫–∞–µ—Ç –∫–æ–≥–¥–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤ –æ–±—Ä–∞—â–∞—é—Ç—Å—è –∫ –æ–±—â–µ–º—É —Ä–µ—Å—É—Ä—Å—É
- –†–µ—à–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (locks)
- –í SQL –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–∞ –≤ —Å–∞–º—É –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

**–ü–æ—á–µ–º—É SQL –ª—É—á—à–µ —á–µ–º Python lock?**
- SQL –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –º–µ–∂–¥—É –ü–†–û–¶–ï–°–°–ê–ú–ò (–Ω–µ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–∞–º–∏)
- SQL –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- –ù–µ –Ω—É–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏ –≤—Ä—É—á–Ω—É—é

