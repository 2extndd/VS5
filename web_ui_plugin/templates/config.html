{% extends "base.html" %}

{% block title %}Configuration - Vinted Notifications{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Configuration</h1>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex align-items-center">
                <i class="bi bi-gear me-2 text-info"></i>
                <h5 class="card-title mb-0">Application Settings</h5>
            </div>
            <div class="card-body">
                <form action="/update_config" method="post">
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card h-100">
                                <div class="card-header d-flex align-items-center">
                                    <i class="bi bi-gear-fill me-2 text-info"></i>
                                    <h5 class="card-title mb-0">System Settings</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="items_per_query" class="form-label">Items Per Query</label>
                                                <input type="number" class="form-control" id="items_per_query"
                                                       name="items_per_query" value="{{ params.items_per_query }}">
                                                <small class="form-text text-muted">Maximum number of items to fetch per
                                                    query</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="query_refresh_delay" class="form-label">Query Refresh Delay
                                                    (seconds)</label>
                                                <input type="number" class="form-control" id="query_refresh_delay"
                                                       name="query_refresh_delay"
                                                       value="{{ params.query_refresh_delay }}">
                                                <small class="form-text text-muted">Delay between query refreshes in
                                                    seconds</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header d-flex align-items-center">
                                    <i class="bi bi-telegram me-2 text-info"></i>
                                    <h5 class="card-title mb-0">Telegram Bot</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            {% if params.telegram_enabled == 'True' %}
                                            <input class="form-check-input" type="checkbox" id="telegram_enabled"
                                                   name="telegram_enabled" checked>
                                            {% else %}
                                            <input class="form-check-input" type="checkbox" id="telegram_enabled"
                                                   name="telegram_enabled">
                                            {% endif %}
                                            <label class="form-check-label" for="telegram_enabled">
                                                Auto Start
                                            </label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="telegram_token" class="form-label">Bot Token</label>
                                        <input type="text" class="form-control" id="telegram_token"
                                               name="telegram_token" value="{{ params.telegram_token }}">
                                        <small class="form-text text-muted">Get this from BotFather</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="telegram_chat_id" class="form-label">Chat ID</label>
                                        <input type="text" class="form-control" id="telegram_chat_id"
                                               name="telegram_chat_id" value="{{ params.telegram_chat_id }}">
                                        <small class="form-text text-muted">The chat ID where notifications will be
                                            sent</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card h-100">
                                <div class="card-header d-flex align-items-center">
                                    <i class="bi bi-shield-lock me-2 text-info"></i>
                                    <h5 class="card-title mb-0">Proxy Settings</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    {% if params.check_proxies == 'True' %}
                                                    <input class="form-check-input" type="checkbox" id="check_proxies"
                                                           name="check_proxies" checked>
                                                    {% else %}
                                                    <input class="form-check-input" type="checkbox" id="check_proxies"
                                                           name="check_proxies">
                                                    {% endif %}
                                                    <label class="form-check-label" for="check_proxies">
                                                        Check Proxies
                                                    </label>
                                                    <small class="form-text text-muted d-block">Verify if proxies are
                                                        working before using them</small>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="proxy_list" class="form-label">Proxy List</label>
                                                <textarea class="form-control" id="proxy_list" name="proxy_list"
                                                          rows="3">{{ params.proxy_list }}</textarea>
                                                <small class="form-text text-muted">List of proxies separated by
                                                    semicolons (;) or newlines<br>
                                                    Supported formats:<br>
                                                    • ip:port<br>
                                                    • user:pass@ip:port (with authentication)<br>
                                                    • http://ip:port<br>
                                                    • http://user:pass@ip:port<br>
                                                    • <strong>ip:port:user:pass (WebShare format)</strong></small>
                                            </div>
                                            <div class="mb-3">
                                                <label for="proxy_list_link" class="form-label">Proxy List Link</label>
                                                <input type="text" class="form-control" id="proxy_list_link"
                                                       name="proxy_list_link" value="{{ params.proxy_list_link }}">
                                                <small class="form-text text-muted">URL to fetch proxies from (one proxy
                                                    per line)</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-primary">Save Configuration</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Country Allowlist - Separate card to avoid nested forms -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex align-items-center">
                <i class="bi bi-globe me-2 text-info"></i>
                <h5 class="card-title mb-0">Country Allowlist</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <!-- Add Country Form -->
                        <form action="/add_country" method="post" class="mb-3">
                            <div class="input-group">
                                <input type="text" class="form-control" name="country" placeholder="DE" 
                                       maxlength="2" required style="text-transform: uppercase;">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-plus-circle"></i> Add
                                </button>
                            </div>
                            <small class="form-text text-muted">2-letter country code (e.g., FR, DE, IT)</small>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <!-- Current Allowlist -->
                        <div class="allowlist-container" style="max-height: 200px; overflow-y: auto;">
                            {% if countries %}
                            <div class="list-group list-group-flush">
                                {% for country in countries %}
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <span class="badge bg-secondary">{{ country }}</span>
                                    <form action="/remove_country/{{ country }}" method="post" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="mt-2">
                                <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal"
                                        data-bs-target="#clearAllowlistModal">
                                    <i class="bi bi-trash"></i> Clear All
                                </button>
                            </div>
                            {% else %}
                            <div class="alert alert-info alert-sm">
                                <i class="bi bi-info-circle"></i> No restrictions - all countries allowed
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex align-items-center">
                <i class="bi bi-toggles me-2 text-info"></i>
                <h5 class="card-title mb-0">Process Control</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6 class="mb-0">Telegram Bot</h6>
                                <small class="text-muted process-status" data-process="telegram">Checking
                                    status...</small>
                            </div>
                            <div>
                                <button class="btn btn-success process-control" data-process="telegram"
                                        data-action="start">
                                    <i class="bi bi-play-fill"></i> Start
                                </button>
                                <button class="btn btn-danger process-control" data-process="telegram"
                                        data-action="stop">
                                    <i class="bi bi-stop-fill"></i> Stop
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6 class="mb-0">RSS Feed</h6>
                                <small class="text-muted process-status" data-process="rss">Checking status...</small>
                            </div>
                            <div>
                                <button class="btn btn-success process-control" data-process="rss" data-action="start">
                                    <i class="bi bi-play-fill"></i> Start
                                </button>
                                <button class="btn btn-danger process-control" data-process="rss" data-action="stop">
                                    <i class="bi bi-stop-fill"></i> Stop
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Railway Auto-Redeploy Monitoring -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex align-items-center">
                <i class="bi bi-arrow-clockwise me-2 text-warning"></i>
                <h5 class="card-title mb-0">Railway Auto-Redeploy System</h5>
                <span class="badge bg-info ms-auto" id="redeploy-status-badge">Loading...</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted">Status Information</h6>
                        <div class="mb-2">
                            <small class="text-muted">403 Errors Count:</small>
                            <span class="fw-bold ms-2" id="error-count">-</span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">First 403 Error:</small>
                            <span class="fw-bold ms-2" id="first-error-time">-</span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Last 403 Error:</small>
                            <span class="fw-bold ms-2" id="last-error-time">-</span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Last Redeploy:</small>
                            <span class="fw-bold ms-2" id="last-redeploy-time">-</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted">Configuration</h6>
                        <div class="mb-2">
                            <small class="text-muted">Redeploy Threshold:</small>
                            <span class="fw-bold ms-2" id="redeploy-threshold">4 minutes</span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Min 403 Errors:</small>
                            <span class="fw-bold ms-2" id="max-errors">5</span>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">Redeploy Needed:</small>
                            <span class="fw-bold ms-2" id="redeploy-needed">No</span>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="refreshRedeployStatus()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh Status
                            </button>
                            <button type="button" class="btn btn-warning btn-sm" onclick="forceRedeploy()" id="force-redeploy-btn">
                                <i class="bi bi-lightning"></i> Force Redeploy
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Clear Allowlist Modal -->
<div class="modal fade" id="clearAllowlistModal" tabindex="-1" aria-labelledby="clearAllowlistModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clearAllowlistModalLabel">Confirm Clearing Allowlist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to clear the entire allowlist? This will allow items from all countries.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="/clear_allowlist" method="post" class="d-inline">
                    <button type="submit" class="btn btn-danger">Clear Allowlist</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Process control buttons
        const processButtons = document.querySelectorAll('.process-control');
        processButtons.forEach(button => {
            button.addEventListener('click', function () {
                const process = this.getAttribute('data-process');
                const action = this.getAttribute('data-action');

                // Disable all buttons for this process
                document.querySelectorAll(`.process-control[data-process="${process}"]`).forEach(btn => {
                    btn.disabled = true;
                });

                fetch(`/control/${process}/${action}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        // Show alert
                        const alertClass = data.status === 'success' ? 'success' :
                            data.status === 'warning' ? 'warning' : 'danger';

                        const alertDiv = document.createElement('div');
                        alertDiv.className = `alert alert-${alertClass} alert-dismissible fade show flash-message`;
                        alertDiv.setAttribute('role', 'alert');
                        alertDiv.innerHTML = `
                        ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;

                        document.querySelector('.flash-messages').appendChild(alertDiv);

                        // Auto-dismiss after 5 seconds
                        setTimeout(() => {
                            const bsAlert = new bootstrap.Alert(alertDiv);
                            bsAlert.close();
                        }, 5000);

                        // Update status
                        checkProcessStatus();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // Re-enable buttons
                        document.querySelectorAll(`.process-control[data-process="${process}"]`).forEach(btn => {
                            btn.disabled = false;
                        });
                    });
            });
        });

        // Check process status
        function checkProcessStatus() {
            fetch('/control/status', {
                method: 'GET'
            })
                .then(response => response.json())
                .then(data => {
                    // Update status text
                    document.querySelector('.process-status[data-process="telegram"]').textContent =
                        data.telegram ? 'Running' : 'Stopped';
                    document.querySelector('.process-status[data-process="rss"]').textContent =
                        data.rss ? 'Running' : 'Stopped';

                    // Update button visibility
                    document.querySelector('.process-control[data-process="telegram"][data-action="start"]').style.display =
                        data.telegram ? 'none' : 'inline-block';
                    document.querySelector('.process-control[data-process="telegram"][data-action="stop"]').style.display =
                        data.telegram ? 'inline-block' : 'none';
                    document.querySelector('.process-control[data-process="rss"][data-action="start"]').style.display =
                        data.rss ? 'none' : 'inline-block';
                    document.querySelector('.process-control[data-process="rss"][data-action="stop"]').style.display =
                        data.rss ? 'inline-block' : 'none';

                    // Re-enable buttons
                    document.querySelectorAll('.process-control').forEach(btn => {
                        btn.disabled = false;
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Set status to unknown
                    document.querySelectorAll('.process-status').forEach(status => {
                        status.textContent = 'Unknown';
                    });
                    // Re-enable all buttons
                    document.querySelectorAll('.process-control').forEach(btn => {
                        btn.disabled = false;
                        btn.style.display = 'inline-block';
                    });
                });
        }

        // Initial check
        checkProcessStatus();
        
        // Auto-refresh redeploy status every 30 seconds
        refreshRedeployStatus();
        setInterval(refreshRedeployStatus, 30000);
    });

    // Railway Auto-Redeploy Functions
    function refreshRedeployStatus() {
        fetch('/redeploy_status')
            .then(response => response.json())
            .then(data => {
                updateRedeployStatus(data);
            })
            .catch(error => {
                console.error('Error fetching redeploy status:', error);
                document.getElementById('redeploy-status-badge').textContent = 'Error';
                document.getElementById('redeploy-status-badge').className = 'badge bg-danger ms-auto';
            });
    }

    function updateRedeployStatus(data) {
        // Update badge
        const badge = document.getElementById('redeploy-status-badge');
        if (data.error) {
            badge.textContent = 'Unavailable';
            badge.className = 'badge bg-secondary ms-auto';
        } else if (data.redeploy_needed) {
            badge.textContent = 'Redeploy Needed';
            badge.className = 'badge bg-warning ms-auto';
        } else if (data.error_403_count > 0) {
            badge.textContent = 'Monitoring';
            badge.className = 'badge bg-warning ms-auto';
        } else {
            badge.textContent = 'OK';
            badge.className = 'badge bg-success ms-auto';
        }

        // Update status information
        document.getElementById('error-count').textContent = data.error_403_count || '0';
        document.getElementById('first-error-time').textContent = 
            data.first_403_time ? new Date(data.first_403_time).toLocaleString() : 'None';
        document.getElementById('last-error-time').textContent = 
            data.last_403_time ? new Date(data.last_403_time).toLocaleString() : 'None';
        document.getElementById('last-redeploy-time').textContent = 
            data.last_redeploy_time ? new Date(data.last_redeploy_time).toLocaleString() : 'Never';
        
        // Update configuration
        document.getElementById('redeploy-threshold').textContent = 
            (data.redeploy_threshold_minutes || 4) + ' minutes';
        document.getElementById('max-errors').textContent = data.max_403_errors || '5';
        document.getElementById('redeploy-needed').textContent = data.redeploy_needed ? 'Yes' : 'No';
        
        // Update redeploy needed styling
        const redeployNeededElement = document.getElementById('redeploy-needed');
        if (data.redeploy_needed) {
            redeployNeededElement.className = 'fw-bold ms-2 text-warning';
        } else {
            redeployNeededElement.className = 'fw-bold ms-2 text-success';
        }
    }

    function forceRedeploy() {
        const button = document.getElementById('force-redeploy-btn');
        const originalText = button.innerHTML;
        
        if (!confirm('Are you sure you want to force a Railway redeploy? This will restart the application.')) {
            return;
        }
        
        button.disabled = true;
        button.innerHTML = '<i class="bi bi-hourglass-split"></i> Redeploying...';
        
        fetch('/force_redeploy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Railway redeploy initiated successfully!');
                refreshRedeployStatus();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error initiating redeploy: ' + error.message);
        })
        .finally(() => {
            button.disabled = false;
            button.innerHTML = originalText;
        });
    }
</script>
{% endblock %}
