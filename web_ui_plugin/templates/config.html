{% extends "base.html" %}

{% block title %}Configuration - Vinted Notifications{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Configuration</h1>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex align-items-center">
                <i class="bi bi-gear me-2 text-info"></i>
                <h5 class="card-title mb-0">Application Settings</h5>
            </div>
            <div class="card-body">
                <form action="/update_config" method="post">
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card h-100">
                                <div class="card-header d-flex align-items-center">
                                    <i class="bi bi-gear-fill me-2 text-info"></i>
                                    <h5 class="card-title mb-0">System Settings</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="items_per_query" class="form-label">Items Per Query</label>
                                                <input type="number" class="form-control" id="items_per_query"
                                                       name="items_per_query" value="{{ params.items_per_query }}">
                                                <small class="form-text text-muted">Maximum number of items to fetch per
                                                    query</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="query_refresh_delay" class="form-label">Query Refresh Delay
                                                    (seconds)</label>
                                                <input type="number" class="form-control" id="query_refresh_delay"
                                                       name="query_refresh_delay"
                                                       value="{{ params.query_refresh_delay }}">
                                                <small class="form-text text-muted">Delay between query refreshes in
                                                    seconds</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header d-flex align-items-center">
                                    <i class="bi bi-telegram me-2 text-info"></i>
                                    <h5 class="card-title mb-0">Telegram Bot</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            {% if params.telegram_enabled == 'True' %}
                                            <input class="form-check-input" type="checkbox" id="telegram_enabled"
                                                   name="telegram_enabled" checked>
                                            {% else %}
                                            <input class="form-check-input" type="checkbox" id="telegram_enabled"
                                                   name="telegram_enabled">
                                            {% endif %}
                                            <label class="form-check-label" for="telegram_enabled">
                                                Auto Start
                                            </label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="telegram_token" class="form-label">Bot Token</label>
                                        <input type="text" class="form-control" id="telegram_token"
                                               name="telegram_token" value="{{ params.telegram_token }}">
                                        <small class="form-text text-muted">Get this from BotFather</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="telegram_chat_id" class="form-label">Chat ID</label>
                                        <input type="text" class="form-control" id="telegram_chat_id"
                                               name="telegram_chat_id" value="{{ params.telegram_chat_id }}">
                                        <small class="form-text text-muted">The chat ID where notifications will be
                                            sent</small>
                                    </div>
                                    
                                    <!-- Telegram Bot Control -->
                                    <div class="mt-3 pt-3 border-top">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <small class="text-muted process-status" data-process="telegram">Checking status...</small>
                                            </div>
                                            <div>
                                                <button type="button" class="btn btn-success btn-sm process-control" data-process="telegram" data-action="start">
                                                    <i class="bi bi-play-fill"></i> Start
                                                </button>
                                                <button type="button" class="btn btn-danger btn-sm process-control" data-process="telegram" data-action="stop">
                                                    <i class="bi bi-stop-fill"></i> Stop
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <!-- Country Allowlist (display only in main form) -->
                            <div class="card h-100">
                                <div class="card-header d-flex align-items-center">
                                    <i class="bi bi-globe me-2 text-info"></i>
                                    <h5 class="card-title mb-0">Country Allowlist</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Add Country</label>
                                        <div class="input-group input-group-sm">
                                            <input type="text" class="form-control" id="new-country" placeholder="DE" 
                                                   maxlength="2" style="text-transform: uppercase;">
                                            <button type="button" class="btn btn-outline-primary" onclick="addCountry()">
                                                <i class="bi bi-plus"></i> Add
                                            </button>
                                        </div>
                                        <small class="form-text text-muted">2-letter country code (e.g., FR, DE, IT)</small>
                                    </div>
                                    
                                    <!-- Current Allowlist Display -->
                                    <div class="allowlist-container" style="max-height: 200px; overflow-y: auto;">
                                        <div id="countries-list">
                                            {% if countries %}
                                                <ul class="list-group list-group-flush">
                                                    {% for country in countries %}
                                                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                                        <span class="badge bg-secondary">{{ country }}</span>
                                                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeCountry('{{ country }}')">
                                                            <i class="bi bi-x"></i>
                                                        </button>
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                                <div class="text-center mt-2">
                                                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="clearAllowlist()">
                                                        <i class="bi bi-trash"></i> Clear All
                                                    </button>
                                                </div>
                                            {% else %}
                                                <div class="alert alert-info alert-sm text-center">
                                                    <small><i class="bi bi-info-circle me-1"></i>No countries in allowlist. All countries allowed.</small>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card h-100">
                                <div class="card-header d-flex align-items-center">
                                    <i class="bi bi-shield-lock me-2 text-info"></i>
                                    <h5 class="card-title mb-0">Proxy Settings</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="mb-3">
                                                <div class="form-check form-switch">
                                                    {% if params.check_proxies == 'True' %}
                                                    <input class="form-check-input" type="checkbox" id="check_proxies"
                                                           name="check_proxies" checked>
                                                    {% else %}
                                                    <input class="form-check-input" type="checkbox" id="check_proxies"
                                                           name="check_proxies">
                                                    {% endif %}
                                                    <label class="form-check-label" for="check_proxies">
                                                        Check Proxies
                                                    </label>
                                                    <small class="form-text text-muted d-block">Verify if proxies are
                                                        working before using them</small>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="proxy_list" class="form-label">Proxy List</label>
                                                <textarea class="form-control" id="proxy_list" name="proxy_list"
                                                          rows="3">{{ params.proxy_list }}</textarea>
                                            </div>
                                            <div class="mb-3">
                                                <label for="proxy_list_link" class="form-label">Proxy List Link</label>
                                                <input type="text" class="form-control" id="proxy_list_link"
                                                       name="proxy_list_link" value="{{ params.proxy_list_link }}">
                                                <small class="form-text text-muted">URL to fetch proxies from (one proxy
                                                    per line)</small>
                                            </div>
                                            

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <button type="submit" class="btn btn-primary">Save Configuration</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>





<!-- Workers Status -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white d-flex align-items-center">
                <i class="bi bi-cpu me-2"></i>
                <h5 class="card-title mb-0">Workers Status (Last 3 Cycles)</h5>
                <button type="button" class="btn btn-light btn-sm ms-auto" onclick="refreshWorkerStats()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
            <div class="card-body">
                <div id="workers-status-container">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading worker statistics...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Workers Status Functions (Compact Version)
function refreshWorkerStats() {
    fetch('/api/worker_stats')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateWorkerStatus(data.workers);
            } else {
                console.error('Error fetching worker stats:', data.error);
                document.getElementById('workers-status-container').innerHTML = 
                    '<div class="alert alert-danger">Error: ' + (data.error || 'Unknown error') + '</div>';
            }
        })
        .catch(error => {
            console.error('Error fetching worker stats:', error);
            document.getElementById('workers-status-container').innerHTML = 
                '<div class="alert alert-danger">Error loading worker statistics</div>';
        });
}

function updateWorkerStatus(workers) {
    const container = document.getElementById('workers-status-container');
    
    if (!workers || Object.keys(workers).length === 0) {
        container.innerHTML = '<div class="alert alert-warning">No worker data available yet. Workers will start reporting after first scan cycle.</div>';
        return;
    }
    
    // Calculate statistics
    const totalWorkers = Object.keys(workers).length;
    const workersWithItems = Object.values(workers).filter(w => w.total_items > 0).length;

    // Group workers by RECENT status (last 3 cycles)
    const errorWorkers = [];
    const idleWorkers = [];
    const activeWorkers = [];

    Object.entries(workers).forEach(([workerId, stats]) => {
        const recentScans = stats.recent_scans || [];
        const workerData = { id: workerId, ...stats };

        if (recentScans.length === 0 || stats.total_scans === 0) {
            // Worker hasn't scanned yet - idle
            idleWorkers.push(workerData);
        } else {
            // Check if last 3 scans had errors
            const hasRecentErrors = recentScans.some(scan => scan.status === 'error');

            if (hasRecentErrors) {
                // Worker had errors in recent scans
                errorWorkers.push(workerData);
            } else {
                // Worker had no errors in recent scans
                activeWorkers.push(workerData);
            }
        }
    });

    const workersWithRecentErrors = errorWorkers.length;
    
    // Build compact HTML with badges
    let html = `
        <div class="row mb-3">
            <div class="col-md-3">
                <div class="alert alert-primary mb-0 py-2">
                    <strong>${totalWorkers}</strong> Total Workers
                </div>
            </div>
            <div class="col-md-3">
                <div class="alert alert-success mb-0 py-2">
                    <strong>${activeWorkers.length}</strong> Working OK
                </div>
            </div>
            <div class="col-md-3">
                <div class="alert alert-danger mb-0 py-2">
                    <strong>${workersWithRecentErrors}</strong> Recent Errors
                </div>
            </div>
            <div class="col-md-3">
                <div class="alert alert-secondary mb-0 py-2">
                    <strong>${idleWorkers.length}</strong> Idle
                </div>
            </div>
        </div>
    `;
    
    // Compact badges for all workers
    html += '<div class="mb-3">';
    html += '<small class="text-muted d-block mb-2">Worker Status (Last scan):</small>';
    html += '<div style="display: flex; flex-wrap: wrap; gap: 4px;">';
    
    // Sort workers by ID
    const sortedWorkers = Object.entries(workers).sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
    
    sortedWorkers.forEach(([workerId, stats]) => {
        let badgeClass = 'bg-success';
        let icon = '✅';
        let title = `Worker #${workerId}: OK`;

        const recentScans = stats.recent_scans || [];

        if (recentScans.length === 0 || stats.total_scans === 0) {
            // Worker hasn't scanned yet - idle
            badgeClass = 'bg-secondary';
            icon = '⏸️';
            title = `Worker #${workerId}: Idle (no scans yet)`;
        } else {
            // Check if last 3 scans had errors
            const hasRecentErrors = recentScans.some(scan => scan.status === 'error');

            if (hasRecentErrors) {
                // Worker had errors in recent scans
                badgeClass = 'bg-danger';
                icon = '❌';
                const errorCount = recentScans.filter(scan => scan.status === 'error').length;
                title = `Worker #${workerId}: ${errorCount} errors in last 3 scans`;
            } else {
                // Worker had no errors in recent scans
                const lastScan = recentScans[recentScans.length - 1];
                if (lastScan.items > 0) {
                    icon = '✅';
                    title = `Worker #${workerId}: ${lastScan.items} items found`;
                } else {
                    icon = '📭';
                    title = `Worker #${workerId}: No items`;
                }
            }
        }

        html += `<span class="badge ${badgeClass}" title="${title}" style="font-size: 11px; padding: 4px 6px;">${icon}${workerId}</span>`;
    });
    
    html += '</div>';
    html += '</div>';
    
    // Show details for workers with errors (collapsed by default)
    if (errorWorkers.length > 0) {
        html += `
            <div class="accordion mt-3" id="errorWorkersAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#errorWorkersDetails">
                            <i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>
                            Workers with Recent Errors (${workersWithRecentErrors}) - Click to expand
                        </button>
                    </h2>
                    <div id="errorWorkersDetails" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <div class="row">
        `;
        
        errorWorkers.forEach(worker => {
            const recentScans = worker.recent_scans.map(scan => {
                const icon = scan.status === 'success' ? '✅' : '❌';
                return `${icon}${scan.time}`;
            }).join(' ');
            
            html += `
                <div class="col-md-4 mb-2">
                    <div class="card border-danger">
                        <div class="card-body p-2">
                            <small><strong>Worker #${worker.id}</strong></small><br>
                            <small class="text-danger">Errors: ${worker.total_errors}</small><br>
                            <small class="text-muted">Recent: ${recentScans || 'No scans'}</small>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// Auto-refresh worker stats every 30 seconds
setInterval(refreshWorkerStats, 30000);

// Initial load
document.addEventListener('DOMContentLoaded', function() {
    refreshWorkerStats();
});

</script>


<!-- Railway Auto-Redeploy Monitoring -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex align-items-center">
                <i class="bi bi-arrow-clockwise me-2 text-warning"></i>
                <h5 class="card-title mb-0">Railway Auto-Redeploy System</h5>
                <span class="badge bg-info ms-auto" id="redeploy-status-badge">Loading...</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted">HTTP Errors Status</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <small class="text-muted d-block">403 Errors:</small>
                                <span class="fw-bold text-danger" id="error-403-count">-</span>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted d-block">401 Errors:</small>
                                <span class="fw-bold text-warning" id="error-401-count">-</span>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted d-block">429 Errors:</small>
                                <span class="fw-bold text-info" id="error-429-count">-</span>
                            </div>
                        </div>
                        <hr>
                        <div class="mb-2">
                            <small class="text-muted">Total Errors:</small>
                            <span class="fw-bold ms-2" id="total-error-count">-</span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Success Streak:</small>
                            <span class="fw-bold ms-2 text-success" id="success-streak">-</span>
                            <small class="text-muted">(need <span id="success-threshold">10</span> to reset errors)</small>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">First Error:</small>
                            <span class="fw-bold ms-2" id="first-error-time">-</span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Last Error:</small>
                            <span class="fw-bold ms-2" id="last-error-time">-</span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Last Redeploy:</small>
                            <span class="fw-bold ms-2" id="last-redeploy-time">-</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted">Configuration</h6>
                        <form id="redeploy-config-form" class="mb-3">
                            <div class="mb-3">
                                <label for="redeploy-threshold-input" class="form-label small">Redeploy Threshold (minutes):</label>
                                <input type="number" class="form-control form-control-sm" id="redeploy-threshold-input" 
                                       name="redeploy_threshold_minutes" value="4" min="1" max="30" step="1">
                                <small class="text-muted">How long to wait before triggering redeploy</small>
                            </div>
                            <div class="mb-3">
                                <label for="max-errors-input" class="form-label small">Min HTTP Errors:</label>
                                <input type="number" class="form-control form-control-sm" id="max-errors-input" 
                                       name="max_http_errors" value="5" min="1" max="20" step="1">
                                <small class="text-muted">Minimum errors needed to trigger redeploy</small>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted">Redeploy Needed:</small>
                                <span class="fw-bold ms-2" id="redeploy-needed">No</span>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <i class="bi bi-save"></i> Save Config
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm" onclick="refreshRedeployStatus()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                                <button type="button" class="btn btn-warning btn-sm" onclick="forceRedeploy()" id="force-redeploy-btn">
                                    <i class="bi bi-lightning"></i> Force Redeploy
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Proxy System Monitoring -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex align-items-center">
                <i class="bi bi-shield-lock me-2 text-primary"></i>
                <h5 class="card-title mb-0">Proxy System Status</h5>
                <span class="badge bg-secondary ms-auto" id="proxy-status-badge">Loading...</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted">Proxy Configuration</h6>
                        <div class="mb-2">
                            <small class="text-muted">Cache Initialized:</small>
                            <span class="fw-bold" id="proxy-cache-init">-</span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Total Cached Proxies:</small>
                            <span class="fw-bold" id="proxy-total-cached">-</span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Proxy Validation:</small>
                            <span class="fw-bold" id="proxy-check-enabled">-</span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Single Proxy Mode:</small>
                            <span class="fw-bold" id="proxy-single-mode">-</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted">Current Status</h6>
                        <div class="mb-2">
                            <small class="text-muted">Current Proxy:</small>
                            <span class="fw-bold font-monospace" id="proxy-current" style="font-size: 0.85rem;">-</span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Last Check Time:</small>
                            <span class="fw-bold" id="proxy-last-check">-</span>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">Recheck Interval:</small>
                            <span class="fw-bold" id="proxy-recheck-interval">-</span>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-primary btn-sm" onclick="refreshProxyStatus()" id="refresh-proxy-btn">
                                <i class="bi bi-arrow-clockwise"></i> Refresh Status
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Clear Allowlist Modal -->
<div class="modal fade" id="clearAllowlistModal" tabindex="-1" aria-labelledby="clearAllowlistModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clearAllowlistModalLabel">Confirm Clearing Allowlist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to clear the entire allowlist? This will allow items from all countries.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="/clear_allowlist" method="post" class="d-inline">
                    <button type="submit" class="btn btn-danger">Clear Allowlist</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Process control buttons
        const processButtons = document.querySelectorAll('.process-control');
        processButtons.forEach(button => {
            button.addEventListener('click', function () {
                const process = this.getAttribute('data-process');
                const action = this.getAttribute('data-action');

                // Disable all buttons for this process
                document.querySelectorAll(`.process-control[data-process="${process}"]`).forEach(btn => {
                    btn.disabled = true;
                });

                fetch(`/control/${process}/${action}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        // Show alert
                        const alertClass = data.status === 'success' ? 'success' :
                            data.status === 'warning' ? 'warning' : 'danger';

                        const alertDiv = document.createElement('div');
                        alertDiv.className = `alert alert-${alertClass} alert-dismissible fade show flash-message`;
                        alertDiv.setAttribute('role', 'alert');
                        alertDiv.innerHTML = `
                        ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;

                        document.querySelector('.flash-messages').appendChild(alertDiv);

                        // Auto-dismiss after 5 seconds
                        setTimeout(() => {
                            const bsAlert = new bootstrap.Alert(alertDiv);
                            bsAlert.close();
                        }, 5000);

                        // Update status
                        checkProcessStatus();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // Re-enable buttons
                        document.querySelectorAll(`.process-control[data-process="${process}"]`).forEach(btn => {
                            btn.disabled = false;
                        });
                    });
            });
        });

        // Check process status
        function checkProcessStatus() {
            fetch('/control/status', {
                method: 'GET'
            })
                .then(response => response.json())
                .then(data => {
                    // Update status text
                    const telegramStatus = document.querySelector('.process-status[data-process="telegram"]');
                    if (telegramStatus) {
                        telegramStatus.textContent = data.telegram ? 'Running' : 'Stopped';
                    }

                    // Update button visibility
                    const telegramStartBtn = document.querySelector('.process-control[data-process="telegram"][data-action="start"]');
                    const telegramStopBtn = document.querySelector('.process-control[data-process="telegram"][data-action="stop"]');
                    
                    if (telegramStartBtn) {
                        telegramStartBtn.style.display = data.telegram ? 'none' : 'inline-block';
                    }
                    if (telegramStopBtn) {
                        telegramStopBtn.style.display = data.telegram ? 'inline-block' : 'none';
                    }

                    // Re-enable buttons
                    document.querySelectorAll('.process-control').forEach(btn => {
                        btn.disabled = false;
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Set status to unknown
                    document.querySelectorAll('.process-status').forEach(status => {
                        status.textContent = 'Unknown';
                    });
                    // Re-enable all buttons
                    document.querySelectorAll('.process-control').forEach(btn => {
                        btn.disabled = false;
                        btn.style.display = 'inline-block';
                    });
                });
        }

        // Initial check
        checkProcessStatus();
        
        // Auto-refresh redeploy status every 30 seconds
        refreshRedeployStatus();
        setInterval(refreshRedeployStatus, 30000);
        
        // Auto-refresh status checks
        refreshProxyStatus();
        refreshRedeployStatus();
        
        // Periodic refresh
        setInterval(refreshProxyStatus, 45000);
        setInterval(checkMigrationStatus, 60000);  // Check migration every 60 seconds
    });

    // Country Allowlist Functions (without forms)
    function addCountry() {
        const input = document.getElementById('new-country');
        const country = input.value.trim().toUpperCase();
        
        if (!country || country.length !== 2) {
            alert('Please enter a valid 2-letter country code');
            return;
        }
        
        fetch('/add_country', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'country=' + encodeURIComponent(country)
        })
        .then(response => {
            if (response.ok) {
                location.reload(); // Reload to update the display
            } else {
                alert('Error adding country');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error adding country');
        });
    }
    
    function removeCountry(country) {
        fetch('/remove_country', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'country=' + encodeURIComponent(country)
        })
        .then(response => {
            if (response.ok) {
                location.reload(); // Reload to update the display
            } else {
                alert('Error removing country');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error removing country');
        });
    }
    
    function clearAllowlist() {
        if (confirm('Are you sure you want to clear the entire allowlist? This will allow items from all countries.')) {
            fetch('/clear_allowlist', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            })
            .then(response => {
                if (response.ok) {
                    location.reload(); // Reload to update the display
                } else {
                    alert('Error clearing allowlist');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error clearing allowlist');
            });
        }
    }

    // Railway Auto-Redeploy Functions
    function refreshRedeployStatus() {
        fetch('/redeploy_status')
            .then(response => response.json())
            .then(data => {
                updateRedeployStatus(data);
            })
            .catch(error => {
                console.error('Error fetching redeploy status:', error);
                document.getElementById('redeploy-status-badge').textContent = 'Error';
                document.getElementById('redeploy-status-badge').className = 'badge bg-danger ms-auto';
            });
    }

    function updateRedeployStatus(data) {
        // Update badge
        const badge = document.getElementById('redeploy-status-badge');
        if (data.error) {
            badge.textContent = 'Unavailable';
            badge.className = 'badge bg-secondary ms-auto';
        } else if (data.redeploy_needed) {
            badge.textContent = 'Redeploy Needed';
            badge.className = 'badge bg-danger ms-auto';
        } else if (data.total_errors > 0) {
            badge.textContent = 'Monitoring';
            badge.className = 'badge bg-warning ms-auto';
        } else {
            badge.textContent = 'OK';
            badge.className = 'badge bg-success ms-auto';
        }

        // Update HTTP errors counts
        document.getElementById('error-403-count').textContent = data.error_403_count || '0';
        document.getElementById('error-401-count').textContent = data.error_401_count || '0';
        document.getElementById('error-429-count').textContent = data.error_429_count || '0';
        document.getElementById('total-error-count').textContent = data.total_errors || '0';
        
        // Update success streak
        document.getElementById('success-streak').textContent = data.success_streak || '0';
        document.getElementById('success-threshold').textContent = data.success_threshold || '10';
        
        // Find the earliest and latest error times from all error types
        const errorTimes = [
            data.first_403_time, data.first_401_time, data.first_429_time
        ].filter(t => t != null);
        const lastErrorTimes = [
            data.last_403_time, data.last_401_time, data.last_429_time
        ].filter(t => t != null);
        
        const firstErrorTime = errorTimes.length > 0 ? 
            new Date(Math.min(...errorTimes.map(t => new Date(t).getTime()))) : null;
        const lastErrorTime = lastErrorTimes.length > 0 ? 
            new Date(Math.max(...lastErrorTimes.map(t => new Date(t).getTime()))) : null;
        
        document.getElementById('first-error-time').textContent = 
            firstErrorTime ? firstErrorTime.toLocaleString() : 'None';
        document.getElementById('last-error-time').textContent = 
            lastErrorTime ? lastErrorTime.toLocaleString() : 'None';
        document.getElementById('last-redeploy-time').textContent = 
            data.last_redeploy_time ? new Date(data.last_redeploy_time).toLocaleString() : 'Never';
        
        // Update configuration form values
        const thresholdValue = data.redeploy_threshold_minutes || 4;
        const errorsValue = data.max_http_errors || 5;
        document.getElementById('redeploy-threshold-input').value = thresholdValue;
        document.getElementById('max-errors-input').value = errorsValue;
        
        document.getElementById('redeploy-needed').textContent = data.redeploy_needed ? 'Yes' : 'No';
        
        // Update redeploy needed styling
        const redeployNeededElement = document.getElementById('redeploy-needed');
        if (data.redeploy_needed) {
            redeployNeededElement.className = 'fw-bold ms-2 text-danger';
        } else {
            redeployNeededElement.className = 'fw-bold ms-2 text-success';
        }
    }

    function forceRedeploy() {
        const button = document.getElementById('force-redeploy-btn');
        const originalText = button.innerHTML;
        
        if (!confirm('Are you sure you want to force a Railway redeploy? This will restart the application.')) {
            return;
        }
        
        button.disabled = true;
        button.innerHTML = '<i class="bi bi-hourglass-split"></i> Redeploying...';
        
        fetch('/force_redeploy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Railway redeploy initiated successfully!');
                refreshRedeployStatus();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error initiating redeploy: ' + error.message);
        })
        .finally(() => {
            button.disabled = false;
            button.innerHTML = originalText;
        });
    }

    // Redeploy Config Form Handler
    document.getElementById('redeploy-config-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const data = {
            redeploy_threshold_minutes: formData.get('redeploy_threshold_minutes'),
            max_http_errors: formData.get('max_http_errors')
        };
        
        fetch('/save_redeploy_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('Redeploy configuration saved successfully!');
                refreshRedeployStatus();
            } else {
                alert('Error saving configuration: ' + (result.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving configuration: ' + error.message);
        });
    });

    // Migration Status Check
    // Proxy System Functions
    function refreshProxyStatus() {
        fetch('/proxy_status')
            .then(response => response.json())
            .then(data => {
                updateProxyStatus(data);
            })
            .catch(error => {
                console.error('Error fetching proxy status:', error);
                document.getElementById('proxy-status-badge').textContent = 'Error';
                document.getElementById('proxy-status-badge').className = 'badge bg-danger ms-auto';
            });
    }

    function updateProxyStatus(data) {
        // Update badge
        if (data.error) {
            document.getElementById('proxy-status-badge').textContent = 'Error';
            document.getElementById('proxy-status-badge').className = 'badge bg-danger ms-auto';
        } else if (data.cache_initialized && data.total_cached_proxies > 0) {
            document.getElementById('proxy-status-badge').textContent = 'Active';
            document.getElementById('proxy-status-badge').className = 'badge bg-success ms-auto';
        } else {
            document.getElementById('proxy-status-badge').textContent = 'Inactive';
            document.getElementById('proxy-status-badge').className = 'badge bg-warning ms-auto';
        }

        // Update proxy configuration
        document.getElementById('proxy-cache-init').textContent = data.cache_initialized ? 'Yes' : 'No';
        document.getElementById('proxy-total-cached').textContent = data.total_cached_proxies || 0;
        document.getElementById('proxy-check-enabled').textContent = data.proxy_check_enabled ? 'Enabled' : 'Disabled';
        document.getElementById('proxy-single-mode').textContent = data.single_proxy_mode ? 'Yes' : 'No';

        // Update current status
        document.getElementById('proxy-current').textContent = data.current_single_proxy || 'None';
        
        if (data.last_check_time && data.last_check_time !== '0') {
            const checkTime = new Date(parseInt(data.last_check_time) * 1000);
            document.getElementById('proxy-last-check').textContent = checkTime.toLocaleString();
        } else {
            document.getElementById('proxy-last-check').textContent = 'Never';
        }
        
        document.getElementById('proxy-recheck-interval').textContent = (data.proxy_recheck_interval_hours || 6) + ' hours';
    }
</script>
{% endblock %}
