# üö® CRITICAL FIX: Workers –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª–∏—Å—å

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

**–¢–æ–ª—å–∫–æ 5 –∏–∑ 72 workers –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å —É—Å–ø–µ—à–Ω–æ!**

```
[WORKERS] ‚ö†Ô∏è WARNING: 67 workers FAILED TO START!
[WORKERS] üìä FINAL COUNT: 5/72 workers are ACTIVE!
```

## üîç –ü—Ä–∏—á–∏–Ω–∞

### –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ query_id –∏ worker_index

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ:**

```python
# Worker –ø–æ–ª—É—á–∞–ª query –∏–∑ –ë–î
query_id = query[0]  # DB ID: –º–æ–∂–µ—Ç –±—ã—Ç—å 1, 5, 75, 120... (—Å –ø—Ä–æ–ø—É—Å–∫–∞–º–∏!)

# Worker –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª —Ç–æ–∫–µ–Ω –ø–æ query_id
token_session = token_pool.get_session_for_worker(query_id)  # ‚ùå –ó–∞–ø—Ä–æ—Å —Ç–æ–∫–µ–Ω–∞ #75!

# –ù–æ token pool —Å–æ–∑–¥–∞–Ω —Ç–æ–ª—å–∫–æ –Ω–∞ 72 —Ç–æ–∫–µ–Ω–∞!
token_pool = TokenPool(target_size=72)  # –ò–Ω–¥–µ–∫—Å—ã: 0, 1, 2, ... 71
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- Worker —Å `query_id = 75` –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω #75
- –í token pool –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ —Ç–æ–∫–µ–Ω—ã 0-71
- Worker –ù–ï –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω
- –ü–æ—Å–ª–µ 5 –ø–æ–ø—ã—Ç–æ–∫ worker **–¢–ï–†–ú–ò–ù–ò–†–£–ï–¢–°–Ø –ù–ê–í–°–ï–ì–î–ê**
- 67 workers —É–ø–∞–ª–∏ –∏–º–µ–Ω–Ω–æ –ø–æ —ç—Ç–æ–π –ø—Ä–∏—á–∏–Ω–µ!

### –ü—Ä–∏–º–µ—Ä –∏–∑ –≤–∞—à–∏—Ö –ª–æ–≥–æ–≤:

```
Worker #75 needs token - creating session #75/72...
                                              ^^^ –ë–æ–ª—å—à–µ —á–µ–º target_size!
```

Query ID = 75 –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–±—ã–ª–∏ —É–¥–∞–ª–µ–Ω–∏—è queries), –Ω–æ —Ç–æ–∫–µ–Ω–æ–≤ —Ç–æ–ª—å–∫–æ 72!

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –†–∞–∑–¥–µ–ª–∏–ª–∏ query_id –∏ worker_index

```python
def continuous_query_worker(query, queue, worker_index=0, start_delay=0):
    """
    Args:
        worker_index: Sequential index (0,1,2...71) for token assignment
    """
    query_id = query[0]  # DB ID (–º–æ–∂–µ—Ç –±—ã—Ç—å –ª—é–±—ã–º: 1, 5, 75...)
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º worker_index –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤ (–≤—Å–µ–≥–¥–∞ 0-71)
    token_session = token_pool.get_session_for_worker(worker_index)  # ‚úÖ
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º query_id –¥–ª—è –ª–æ–≥–æ–≤ –∏ DB –æ–ø–µ—Ä–∞—Ü–∏–π
    logger.info(f"[WORKER #{query_id}] Starting...")  # –î–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –ª–æ–≥–æ–≤
    db.update_query_last_found(query_id, timestamp)    # –î–ª—è DB –æ–ø–µ—Ä–∞—Ü–∏–π
```

### –ö–∞–∫ —Ç–µ–ø–µ—Ä—å –Ω–∞–∑–Ω–∞—á–∞—é—Ç—Å—è —Ç–æ–∫–µ–Ω—ã:

```
Query DB ID ‚Üí Worker Index ‚Üí Token Index
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    1      ‚Üí      0       ‚Üí      0
    5      ‚Üí      1       ‚Üí      1
   10      ‚Üí      2       ‚Üí      2
   75      ‚Üí      3       ‚Üí      3  ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ!
  120      ‚Üí      4       ‚Üí      4
  ...
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ **–í—Å–µ 72 workers —Ç–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞—Ç —Ç–æ–∫–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ**  
‚úÖ **Worker index –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π:** 0, 1, 2, ... 71  
‚úÖ **Query ID –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–æ–≥–æ–≤ –∏ DB**  
‚úÖ **Token pool mapping –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π:** worker 0 ‚Üí token 0, worker 1 ‚Üí token 1, etc.  

## ‚ùå –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ retry –¥–ª—è —É–ø–∞–≤—à–∏—Ö workers!

**–°–µ–π—á–∞—Å:** –ï—Å–ª–∏ worker –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ ‚Üí –æ–Ω **–ù–ò–ö–û–ì–î–ê** –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è!

```python
if not token_session:
    logger.error(f"[WORKER #{query_id}] Worker TERMINATED!")
    return  # ‚Üê Worker —É–º–µ—Ä –Ω–∞–≤—Å–µ–≥–¥–∞!
```

**–≠—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ –±—É–¥—É—â–µ–º:**
- –î–æ–±–∞–≤–∏—Ç—å watchdog –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ workers
- –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å —É–ø–∞–≤—à–∏–µ workers –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ò–ª–∏ —É–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ retry –ø–æ–ø—ã—Ç–æ–∫ —Å –±–æ–ª—å—à–∏–º–∏ —Ç–∞–π–º–∞—É—Ç–∞–º–∏

–ù–æ —Å —Ç–µ–∫—É—â–∏–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º **–í–°–ï workers –¥–æ–ª–∂–Ω—ã —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å —É—Å–ø–µ—à–Ω–æ**, —Ç–∞–∫ —á—Ç–æ —ç—Ç–∞ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞.

## üöÄ –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

**–§–∞–π–ª:** `core.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `worker_index` –≤ `continuous_query_worker()`
2. –í—Å–µ –≤—ã–∑–æ–≤—ã `get_session_for_worker()` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç `worker_index`
3. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ workers –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è `idx` –∏–∑ `enumerate()`

**–ö–æ–º–º–∏—Ç:** `c020581`

## üìà –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

```
[TOKEN_POOL] ‚úÖ PARALLEL pre-warming complete: 72 tokens in 38.2s!
[WORKERS] üöÄ Starting ALL 72 workers INSTANTLY...
[WORKER #1] Got session #1 with UA: ...
[WORKER #5] Got session #2 with UA: ...  ‚Üê Worker index = 1 (sequential)
[WORKER #75] Got session #3 with UA: ... ‚Üê Worker index = 2 (sequential)
...
[WORKERS] üìä FINAL COUNT: 72/72 workers are ACTIVE! ‚úÖ
[WORKERS] ‚úÖ All 72 workers are running successfully!
```

**–í—Å–µ 72 –∑–∞–ø—Ä–æ—Å–∞ –±—É–¥—É—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ!** üéâ

